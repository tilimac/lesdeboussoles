{% extends "BackofficeBundle::layout.html.twig" %}

{% block stylesheets %}
    {{ parent() }}

    {% stylesheets
    'bundles/app/lib/bootstrap-switch/css/bootstrap3/bootstrap-switch.min.css' filter='cssrewrite' %}
    <link rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
{% endblock %}

{% block page_container %}
    <style>
        .fa-sort{
            color: #ccc;
        }
    </style>
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">Liste d'inscrit</h1>
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <!-- /.row -->
    <div class="row">
        <div class="col-lg-12">
            <table class="table table-bordered table-hover table-striped">
                <thead>
                <tr>
                    <th class="col-xs-12">
                        {{ knp_pagination_sortable(pagination, 'Nom d\'utilisateur', 'u.username') }}
                        {% if pagination.isSorted('u.username') %}
                            <i class="fa fa-sort-{{ pagination.params.direction }} pull-right"></i>
                        {% else %}
                            <i class="fa fa-sort pull-right"></i>
                        {% endif %}
                    </th>
                    <th style="min-width: 310px;">
                        Option
                    </th>
                </tr>
                </thead>
                <tbody>
                {% for user in pagination %}
                    <tr {% if loop.index is odd %}class="color"{% endif %}>
                        <td>{{ user.username }}</td>
                        <td>
                            <button class="btn btn-danger remove-user" data-user="{{ user.id }}" data-username="{{ user.username }}"><span class="fa fa-times"></span> Supprimer</button>
                            <select class="form-control switch-user" data-user="{{ user.id }}" style="width: 100px;display: inline;">
                                <option value="ROLE_GUEST" {% if user.hasRole('ROLE_GUEST') %}selected="selected"{% endif %}>Invité</option>
                                <option value="ROLE_MEMBER" {% if user.hasRole('ROLE_MEMBER') %}selected="selected"{% endif %}>Membre</option>
                                <option value="ROLE_ADMIN" {% if user.hasRole('ROLE_ADMIN') or user.hasRole('ROLE_SUPER_ADMIN') %}selected="selected"{% endif %}>Admin</option>
                            </select>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            {# display navigation #}
            <div class="navigation">
                {{ knp_pagination_render(pagination) }}
            </div>
        </div>
    </div>

    <div id="modal_remove_user" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel"></h4>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        Êtes-vous sûr de vouloir supprimer <b></b>?
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Supprimer</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(function(){
            var $removeUser = $(".remove-user");
            var $modalRemoveUser = $("#modal_remove_user");
            var $switchUser = $(".switch-user");

            var userId;
            $removeUser.on('click', function(e){
                e.preventDefault();
                userId = $(this).data('user');

                $modalRemoveUser.find('.modal-body b').html($(this).data('username'));
                $modalRemoveUser.modal('show');
            });

            $modalRemoveUser.find('.btn-danger').on('click', function(e){
                e.preventDefault();

                $.post(Routing.generate('_admin_user_delete', {user: userId}), function(){
                    location.reload();
                });
            });

            $switchUser.on('change', function(e){
                e.preventDefault();

                $.post(Routing.generate('_admin_user_switch', {user: $(this).data('user'), role: $(this).val()}));
            });
        });
    </script>
{% endblock %}